name: Sync PR Diff to Port (Fixed)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sync-pr-diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Process PR and update Port
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PORT_CLIENT_ID: ${{ secrets.PORT_CLIENT_ID }}
          PORT_CLIENT_SECRET: ${{ secrets.PORT_CLIENT_SECRET }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_ID: ${{ github.event.pull_request.id }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_HTML_URL: ${{ github.event.pull_request.html_url }}
          PR_ADDITIONS: ${{ github.event.pull_request.additions }}
          PR_DELETIONS: ${{ github.event.pull_request.deletions }}
          PR_CHANGED_FILES: ${{ github.event.pull_request.changed_files }}
        run: |
          python3 << 'EOF'
          import os
          import requests
          import json
          import subprocess
          import sys
          
          def debug_print(message):
              """Print debug message with emoji"""
              print(f"üîß DEBUG: {message}")
          
          def get_pr_files():
              """Get list of changed files using gh CLI"""
              debug_print("Getting changed files...")
              try:
                  result = subprocess.run(
                      ['gh', 'pr', 'diff', os.environ['PR_NUMBER'], '--name-only'],
                      capture_output=True,
                      text=True,
                      check=True
                  )
                  files = [f.strip() for f in result.stdout.split('\n') if f.strip()]
                  debug_print(f"Found {len(files)} changed files")
                  return files
              except subprocess.CalledProcessError as e:
                  debug_print(f"Error getting files: {e}")
                  return []
          
          def get_pr_diff():
              """Get PR diff using gh CLI"""
              debug_print("Getting PR diff...")
              try:
                  result = subprocess.run(
                      ['gh', 'pr', 'diff', os.environ['PR_NUMBER']],
                      capture_output=True,
                      text=True,
                      check=True
                  )
                  # Truncate if too long
                  diff = result.stdout
                  if len(diff) > 8000:
                      diff = diff[:8000] + "\n\n... (diff truncated)"
                  debug_print(f"Got diff, length: {len(diff)} chars")
                  return diff
              except subprocess.CalledProcessError as e:
                  debug_print(f"Error getting diff: {e}")
                  return "Error retrieving diff"
          
          def create_diff_content():
              """Create formatted markdown content"""
              debug_print("Creating formatted content...")
              files = get_pr_files()
              diff = get_pr_diff()
              
              content = f"""## üìä Pull Request: {os.environ['PR_TITLE']}
          
          ### üìà Change Statistics
          - **Files Changed:** {os.environ['PR_CHANGED_FILES']}
          - **Lines Added:** +{os.environ['PR_ADDITIONS']}
          - **Lines Deleted:** -{os.environ['PR_DELETIONS']}
          
          ### üìÅ Modified Files
          """
              
              for file in files[:20]:  # Limit to first 20 files
                  content += f"- `{file}`\n"
              
              if len(files) > 20:
                  content += f"- ... and {len(files) - 20} more files\n"
              
              content += f"""
          ### üîç Code Changes
          
          ```diff
          {diff}
          ```
          
          [üìñ View Full Diff on GitHub]({os.environ['PR_HTML_URL']}/files)
          """
              
              return content, files
          
          def get_port_token():
              """Get Port access token with detailed error handling"""
              debug_print("Attempting Port authentication...")
              
              client_id = os.environ.get('PORT_CLIENT_ID', '').strip()
              client_secret = os.environ.get('PORT_CLIENT_SECRET', '').strip()
              
              if not client_id or not client_secret:
                  raise Exception("PORT_CLIENT_ID or PORT_CLIENT_SECRET is empty")
              
              debug_print(f"Client ID length: {len(client_id)}")
              debug_print(f"Client Secret length: {len(client_secret)}")
              
              # FIXED: Use camelCase property names
              payload = {
                  'clientId': client_id,
                  'clientSecret': client_secret
              }
              
              debug_print("Sending authentication request...")
              debug_print(f"Payload keys: {list(payload.
